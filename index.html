<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Balanced Student Group Generator</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- jsPDF and html2canvas for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc; /* Light gray background */
            padding: 20px;
        }
        .card {
            background-color: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            border: 1px solid #e2e8f0;
        }
        .input-field {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            transition: border-color 0.2s;
        }
        .input-field:focus {
            border-color: #0d9488; /* Teal-600 */
            outline: none;
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.3);
        }
        .btn-primary {
            background-color: #0d9488;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 700;
            transition: background-color 0.3s, transform 0.1s;
            box-shadow: 0 4px #0f766e;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #0f766e;
        }
        .btn-primary:active:not(:disabled) {
            transform: translateY(2px);
            box-shadow: 0 2px #0f766e;
        }
        .btn-primary:disabled {
            background-color: #a7f3d0;
            cursor: not-allowed;
            box-shadow: none;
        }
        .btn-secondary {
            background-color: #f0fdfa;
            color: #0d9488;
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid #0d9488;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .btn-secondary:hover {
            background-color: #ccfbf1;
        }
        .btn-export {
            background-color: #3b82f6;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .btn-export:hover {
            background-color: #2563eb;
        }
        .btn-pdf {
            background-color: #ef4444;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .btn-pdf:hover {
            background-color: #dc2626;
        }
        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #ffffff;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen">
    <script>
        // --- GLOBAL STATE ---
        let students = [];
        let mustBeTogether = []; // Array of [studentId1, studentId2]
        let conflictConstraints = []; // Array of [studentId1, studentId2, studentId3, ...] where no two can be together
        let currentRosterName = "Default Roster";
        let lastGeneratedGroups = [];

        // Constants for the Group Generation Algorithm
        const epsilon = 1e-9; // Small number for floating point comparisons
        const SD_TOLERANCE_FOR_SIZE_BIAS = 0.5; // Allow a group to be chosen if its SD is only slightly worse, but it is much smaller.

        // --- UTILITY FUNCTIONS ---

        /** Converts letter grades (A=4, B=3, C=2, D=1, E=0) to a numeric score. */
        const gradeToScore = (grade) => {
            const grades = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1, 'F': 0 };
            return grades[grade.toUpperCase()] || 0;
        };

        /** Calculates the combined score (average behavior, average academic, leader count) for a group. */
        const calculateGroupScore = (group) => {
            if (group.length === 0) return {
                avgBehavior: 0,
                avgAcademic: 0,
                leaderCount: 0,
                scoreSum: 0,
                size: 0
            };

            const behaviorSum = group.reduce((sum, s) => sum + s.behavior, 0);
            const academicSum = group.reduce((sum, s) => sum + s.academicScore, 0);
            const leaderCount = group.filter(s => s.role === 'Leader').length;

            const avgBehavior = behaviorSum / group.length;
            const avgAcademic = academicSum / group.length;

            // Combine scores for overall balancing: Academic is weighted slightly higher
            const scoreSum = (avgBehavior * 1.0) + (avgAcademic * 1.5);

            return { avgBehavior, avgAcademic, leaderCount, scoreSum, size: group.length };
        };

        /** Calculates the Standard Deviation of a set of group scores (for balancing). */
        const calculateStdDev = (groupStats) => {
            if (groupStats.length === 0) return 0;
            
            // Only consider groups with students
            const scores = groupStats.filter(s => s.size > 0).map(s => s.scoreSum);
            if (scores.length === 0) return 0;

            const mean = scores.reduce((sum, score) => sum + score, 0) / scores.length;
            const variance = scores.reduce((sum, score) => sum + Math.pow(score - mean, 2), 0) / scores.length;
            return Math.sqrt(variance);
        };

        /** Checks if a student has an implicit or explicit conflict with any student in a target group. */
        const hasConflict = (student, targetGroup, conflictConstraints) => {
            const studentId = student.id;
            const targetIds = targetGroup.map(s => s.id);

            // 1. Check for automatic Bully/Victim conflict
            const hasRoleConflict = targetGroup.some(targetStudent =>
                (student.role === 'Bully' && targetStudent.role === 'Victim') ||
                (student.role === 'Victim' && targetStudent.role === 'Bully')
            );
            if (hasRoleConflict) return true;

            // 2. Check against explicit multi-student separation constraints
            // A conflict occurs if the current student ID, and any ID in the target group, 
            // are both present in the same conflict constraint group.
            for (const constraint of conflictConstraints) {
                if (constraint.includes(studentId)) {
                    // Check if any student currently in the group is also in this constraint
                    const groupConflict = targetIds.some(targetId => constraint.includes(targetId));
                    if (groupConflict) return true;
                }
            }

            return false;
        };

        // --- DATA MANAGEMENT (Mock Persistence) ---
        const loadStudents = () => {
            try {
                const storedData = JSON.parse(localStorage.getItem('studentGroupData'));
                if (storedData) {
                    students = storedData.students || [];
                    mustBeTogether = storedData.mustBeTogether || [];
                    conflictConstraints = storedData.conflictConstraints || [];
                    currentRosterName = storedData.currentRosterName || "Local Roster";
                }
            } catch (e) {
                console.error("Error loading state from localStorage:", e);
            }
            window.renderStudentRoster();
            window.renderConstraints();
        };

        const saveStudents = () => {
            const dataToStore = { students, mustBeTogether, conflictConstraints, currentRosterName };
            localStorage.setItem('studentGroupData', JSON.stringify(dataToStore));
        };

        const getStudentById = (id) => students.find(s => s.id === id);

        // --- INITIAL DATA SETUP ---
        window.addDefaultStudents = () => {
            students = [
                { id: crypto.randomUUID(), name: "Alice J.", behavior: 5, academics: 'A', academicScore: gradeToScore('A'), role: 'Leader' },
                { id: crypto.randomUUID(), name: "Bob K.", behavior: 2, academics: 'D', academicScore: gradeToScore('D'), role: 'Victim' },
                { id: crypto.randomUUID(), name: "Charlie L.", behavior: 4, academics: 'B', academicScore: gradeToScore('B'), role: '-' },
                { id: crypto.randomUUID(), name: "David M.", behavior: 1, academics: 'C', academicScore: gradeToScore('C'), role: 'Bully' },
                { id: crypto.randomUUID(), name: "Eve N.", behavior: 5, academics: 'A', academicScore: gradeToScore('A'), role: 'Leader' },
                { id: crypto.randomUUID(), name: "Fiona O.", behavior: 3, academics: 'B', academicScore: gradeToScore('B'), role: '-' },
                { id: crypto.randomUUID(), name: "George P.", behavior: 4, academics: 'E', academicScore: gradeToScore('E'), role: '-' },
                { id: crypto.randomUUID(), name: "Hannah Q.", behavior: 3, academics: 'C', academicScore: gradeToScore('C'), role: '-' },
            ];
            mustBeTogether = [];
            conflictConstraints = [];
            currentRosterName = "Sample Roster";
            saveStudents();
            window.renderStudentRoster();
            window.renderConstraints();
            window.showMessage('success', 'Loaded sample student data for demonstration.');
        };

        // --- UI RENDER/INPUT HANDLERS ---
        window.addStudentRow = (student = null) => {
            const newStudent = student || {
                id: crypto.randomUUID(),
                name: '',
                behavior: 3,
                academics: 'C',
                academicScore: gradeToScore('C'),
                role: '-'
            };
            if (!student) {
                students.push(newStudent);
                saveStudents();
            }
            window.renderStudentRoster();
        };

        window.updateRosterFromInputs = (studentId, field, value) => {
            const student = students.find(s => s.id === studentId);
            if (!student) return;

            if (field === 'name') {
                student.name = value;
            } else if (field === 'behavior') {
                student.behavior = parseInt(value, 10);
            } else if (field === 'academics') {
                student.academics = value;
                student.academicScore = gradeToScore(value);
            } else if (field === 'role') {
                student.role = value;
            }
            
            saveStudents();
            window.renderConstraints();
            // Do not rerender the whole roster to keep input focus, only update constraints
        };

        window.removeStudent = (studentId) => {
            students = students.filter(s => s.id !== studentId);

            // Clean up constraints
            mustBeTogether = mustBeTogether.filter(c => !c.includes(studentId));
            conflictConstraints = conflictConstraints.map(c => c.filter(id => id !== studentId)).filter(c => c.length >= 2);

            saveStudents();
            window.renderStudentRoster();
            window.renderConstraints();
            window.showMessage('success', 'Student removed and constraints updated.');
        };

        window.renderStudentRoster = () => {
            const list = document.getElementById('student-list');
            list.innerHTML = '';
            
            const emptyMessage = document.getElementById('empty-roster-message');
            if (students.length === 0) {
                emptyMessage.classList.remove('hidden');
                return;
            } else {
                emptyMessage.classList.add('hidden');
            }

            students.forEach(student => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition duration-150';

                // Name input
                const nameCell = `<td class="p-3 whitespace-nowrap"><input type="text" value="${student.name}" oninput="window.updateRosterFromInputs('${student.id}', 'name', this.value)" placeholder="Student Name" class="input-field w-full sm:w-48"/></td>`;

                // Behavior input (1-5)
                const behaviorOptions = [5, 4, 3, 2, 1].map(b => `<option value="${b}" ${student.behavior === b ? 'selected' : ''}>${b}</option>`).join('');
                const behaviorCell = `<td class="p-3 whitespace-nowrap"><select onchange="window.updateRosterFromInputs('${student.id}', 'behavior', this.value)" class="input-field w-16">${behaviorOptions}</select></td>`;

                // Academic input (A-E)
                const academicGrades = ['A', 'B', 'C', 'D', 'E'];
                const academicOptions = academicGrades.map(g => `<option value="${g}" ${student.academics === g ? 'selected' : ''}>${g}</option>`).join('');
                const academicCell = `<td class="p-3 whitespace-nowrap"><select onchange="window.updateRosterFromInputs('${student.id}', 'academics', this.value)" class="input-field w-16">${academicOptions}</select></td>`;

                // Role input
                const roles = ['-', 'Leader', 'Bully', 'Victim'];
                const roleOptions = roles.map(r => `<option value="${r}" ${student.role === r ? 'selected' : ''}>${r}</option>`).join('');
                const roleCell = `<td class="p-3 whitespace-nowrap"><select onchange="window.updateRosterFromInputs('${student.id}', 'role', this.value)" class="input-field w-24">${roleOptions}</select></td>`;

                // Delete button
                const deleteCell = `<td class="p-3 text-right"><button onclick="window.removeStudent('${student.id}')" class="text-red-500 hover:text-red-700 transition duration-150 p-2 rounded-full"><i class="fas fa-trash-alt"></i></button></td>`;

                row.innerHTML = nameCell + behaviorCell + academicCell + roleCell + deleteCell;
                list.appendChild(row);
            });
        };

        window.createStudentSelect = (id, constraintType, constraintIndex, studentIndexInConstraint, selectedId = '') => {
            const select = document.createElement('select');
            select.id = id;
            select.className = 'input-field w-full text-sm';
            select.onchange = (e) => window.updateConstraint(constraintType, constraintIndex, studentIndexInConstraint, e.target.value);
            
            let optionsHtml = '<option value="" disabled selected>Select Student</option>';
            optionsHtml += students.map(s => 
                `<option value="${s.id}" ${s.id === selectedId ? 'selected' : ''}>${s.name || 'Unnamed Student'}</option>`
            ).join('');
            select.innerHTML = optionsHtml;
            return select;
        };

        window.renderConstraints = () => {
            const togetherList = document.getElementById('must-be-together-list');
            const conflictList = document.getElementById('conflict-constraints-list');
            togetherList.innerHTML = '';
            conflictList.innerHTML = '';

            // Render Must Be Together (Pairs)
            mustBeTogether.forEach((constraint, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center space-x-2 p-3 bg-white border border-green-100 rounded-lg shadow-sm';
                
                const select1 = window.createStudentSelect(`together-select-${index}-0`, 'together', index, 0, constraint[0]);
                const select2 = window.createStudentSelect(`together-select-${index}-1`, 'together', index, 1, constraint[1]);
                
                const removeButton = `<button onclick="window.removeConstraint('together', ${index})" class="text-red-500 hover:text-red-700 text-lg ml-2"><i class="fas fa-circle-xmark"></i></button>`;

                div.appendChild(select1);
                div.innerHTML += '<span class="text-gray-500 font-semibold"> & </span>';
                div.appendChild(select2);
                div.innerHTML += removeButton;
                togetherList.appendChild(div);
            });

            // Render Must Be Separated (Groups)
            conflictConstraints.forEach((constraint, index) => {
                const div = document.createElement('div');
                div.className = 'p-3 bg-white border border-red-100 rounded-lg shadow-sm';
                
                const selectContainer = document.createElement('div');
                selectContainer.className = 'flex flex-wrap gap-2 mb-2';

                constraint.forEach((studentId, studentIndex) => {
                    const select = window.createStudentSelect(`conflict-select-${index}-${studentIndex}`, 'conflict', index, studentIndex, studentId);
                    selectContainer.appendChild(select);
                });

                const controls = document.createElement('div');
                controls.className = 'flex justify-between items-center mt-2';
                
                const addButton = `<button onclick="window.updateConstraint('conflict', ${index}, ${constraint.length}, '')" class="text-xs text-blue-600 hover:text-blue-800 font-medium flex items-center"><i class="fas fa-plus mr-1"></i> Add Member</button>`;
                const removeConstraintButton = `<button onclick="window.removeConstraint('conflict', ${index})" class="text-red-500 hover:text-red-700 text-sm"><i class="fas fa-trash-alt mr-1"></i> Remove Group</button>`;
                
                controls.innerHTML = addButton + removeConstraintButton;

                div.appendChild(selectContainer);
                div.appendChild(controls);
                conflictList.appendChild(div);
            });
        };

        window.addConstraint = (type) => {
            if (students.length < 2) {
                window.showMessage('warning', 'You need at least two students to add a constraint.');
                return;
            }
            if (type === 'together') {
                mustBeTogether.push(['', '']);
            } else if (type === 'conflict') {
                // Initialize with two empty strings, requiring at least 2 for separation
                conflictConstraints.push(['', '']);
            }
            saveStudents();
            window.renderConstraints();
        };

        window.updateConstraint = (type, constraintIndex, studentIndex, studentId) => {
            let constraintArray;
            if (type === 'together') {
                constraintArray = mustBeTogether;
            } else if (type === 'conflict') {
                constraintArray = conflictConstraints;
            }

            if (studentIndex >= constraintArray[constraintIndex].length) {
                // Add new member to conflict constraint
                constraintArray[constraintIndex].push(studentId);
            } else {
                // Update existing member
                constraintArray[constraintIndex][studentIndex] = studentId;
                
                // For conflict groups, check for duplicates and remove if necessary
                if (type === 'conflict') {
                    const currentConstraint = constraintArray[constraintIndex];
                    const uniqueStudents = [...new Set(currentConstraint.filter(id => id !== ''))];
                    if (currentConstraint.filter(id => id !== '').length !== uniqueStudents.length) {
                        window.showMessage('warning', 'Duplicate students were removed from the separation group.');
                        constraintArray[constraintIndex] = uniqueStudents;
                    }
                    if (constraintArray[constraintIndex].length < 2) {
                        constraintArray[constraintIndex] = ['', '']; // Reset if too few members
                    }
                }
            }

            saveStudents();
            window.renderConstraints();
        };

        window.removeConstraint = (type, index) => {
            if (type === 'together') {
                mustBeTogether.splice(index, 1);
            } else if (type === 'conflict') {
                conflictConstraints.splice(index, 1);
            }
            saveStudents();
            window.renderConstraints();
            window.showMessage('success', 'Constraint removed.');
        };


        // --- CORE GROUP GENERATION ALGORITHM (Piece 2/2) ---

        window.generateGroups = () => {
            const numGroups = parseInt(document.getElementById('num-groups').value, 10);
            const allStudents = students;
            const generateButton = document.getElementById('generate-button');
            const originalHtml = generateButton.innerHTML;
            
            window.showMessage('warning', 'Generating groups...');
            generateButton.disabled = true;
            generateButton.innerHTML = '<div class="spinner"></div><span class="ml-2">Generating...</span>';

            if (allStudents.length === 0) {
                window.showMessage('error', 'The roster is empty. Please add students first.');
                generateButton.disabled = false;
                generateButton.innerHTML = originalHtml;
                return;
            }

            if (numGroups <= 0) {
                window.showMessage('error', 'The number of groups must be 1 or more.');
                generateButton.disabled = false;
                generateButton.innerHTML = originalHtml;
                return;
            }

            if (numGroups > allStudents.length) {
                window.showMessage('error', `You cannot create ${numGroups} groups for only ${allStudents.length} students.`);
                generateButton.disabled = false;
                generateButton.innerHTML = originalHtml;
                return;
            }
            
            // Use a timeout to allow the spinner to render before the heavy calculation
            setTimeout(() => {
                // Filter and clean constraints
                const validStudents = new Set(allStudents.map(s => s.id));
                const isValidConstraintPair = (c) => c.length === 2 && validStudents.has(c[0]) && validStudents.has(c[1]);
                const isValidSeparationGroup = (c) => c.length >= 2 && c.every(id => validStudents.has(id));

                const validMustBeTogether = mustBeTogether.filter(isValidConstraintPair);
                const validConflictConstraints = conflictConstraints.filter(isValidSeparationGroup);

                let groups = Array.from({ length: numGroups }, () => []);
                let assignedStudentIds = new Set();
                let success = true;

                // --- 1. Handle Must Be Together Constraints ---
                // Similar logic as before, assigning to smallest valid group
                for (const constraint of validMustBeTogether) {
                    const [id1, id2] = constraint;
                    const s1 = allStudents.find(s => s.id === id1);
                    const s2 = allStudents.find(s => s.id === id2);

                    if (assignedStudentIds.has(id1) || assignedStudentIds.has(id2) || !s1 || !s2) {
                        continue;
                    }

                    // Pre-check: Must Be Together students cannot have a conflict with each other
                    if (hasConflict(s1, [s2], validConflictConstraints)) {
                         window.showMessage("error", `Cannot satisfy 'Must Be Together' constraint: ${s1.name} and ${s2.name} have an automatic (Bully/Victim) or explicit conflict.`);
                         success = false;
                         break;
                    }

                    let bestGroupIndex = -1;
                    let minSize = Infinity;

                    for (let i = 0; i < numGroups; i++) {
                        const conflicts1 = hasConflict(s1, groups[i], validConflictConstraints);
                        const conflicts2 = hasConflict(s2, groups[i], validConflictConstraints);

                        if (!conflicts1 && !conflicts2) {
                            if (groups[i].length < minSize) {
                                minSize = groups[i].length;
                                bestGroupIndex = i;
                            }
                        }
                    }

                    if (bestGroupIndex !== -1) {
                        groups[bestGroupIndex].push(s1, s2);
                        assignedStudentIds.add(id1);
                        assignedStudentIds.add(id2);
                    } else {
                        window.showMessage("error", `Cannot satisfy a 'Must Be Together' constraint for ${s1.name} and ${s2.name} due to conflicts with initial groups.`);
                        success = false;
                        break;
                    }
                }

                // --- 2. Assign Remaining Students using Global Balance (Standard Deviation of Averages) ---
                if (success) {
                    let unassignedStudents = allStudents.filter(s => !assignedStudentIds.has(s.id));

                    // Prioritize placing high-impact students (Leaders, Bully/Victim, high combined score) first
                    unassignedStudents.sort((a, b) => {
                        const roleOrder = (role) => {
                            if (role === 'Leader') return 3;
                            if (role === 'Bully' || role === 'Victim') return 2;
                            return 1;
                        };
                        const roleDiff = roleOrder(b.role) - roleOrder(a.role);
                        if (roleDiff !== 0) return roleDiff;

                        // Combined score tie-breaker
                        const scoreDiff = (b.behavior + b.academicScore) - (a.behavior + a.academicScore);
                        if (scoreDiff !== 0) return scoreDiff;

                        // Final random tie-breaker
                        return Math.random() - 0.5;
                    });

                    for (const student of unassignedStudents) {
                        let bestGroupIndex = -1;
                        let minOverallStdDev = Infinity;
                        let minGroupSize = Infinity;
                        
                        // Find the current smallest group size among all groups
                        const currentMinSize = Math.min(...groups.map(g => g.length));

                        for (let i = 0; i < numGroups; i++) {
                            const currentGroup = groups[i];

                            // CHECK CONFLICTS with the multi-student separation constraints
                            if (hasConflict(student, currentGroup, validConflictConstraints)) {
                                continue;
                            }

                            const hypotheticalGroups = groups.map((g, index) =>
                                index === i ? [...g, student] : g
                            );

                            const hypotheticalGroupStats = hypotheticalGroups.map(g => calculateGroupScore(g));

                            // This calculates SD based on the *average* score of the hypothetical groups
                            const currentStdDev = calculateStdDev(hypotheticalGroupStats);
                            const tentativeStats = hypotheticalGroupStats[i];
                            const groupSize = tentativeStats.size;

                            // 1. Check for strictly better SD (Primary Criterion)
                            if (currentStdDev < minOverallStdDev - epsilon) {
                                bestGroupIndex = i;
                                minOverallStdDev = currentStdDev;
                                minGroupSize = groupSize;
                            }
                            
                            // 2. Strong Size Bias Check: If the resulting SD is close, strongly prefer the smallest group.
                            // This specifically targets the issue where large groups keep the SD artificially low.
                            else if (groupSize < minGroupSize && currentStdDev < minOverallStdDev + SD_TOLERANCE_FOR_SIZE_BIAS) {
                                // We found a smaller group that is close enough in SD. Accept it.
                                bestGroupIndex = i;
                                minOverallStdDev = currentStdDev; // Accept the slightly higher SD
                                minGroupSize = groupSize;
                            }
                            
                            // 3. Strict Tie-breaker (SD is mathematically identical)
                            else if (Math.abs(currentStdDev - minOverallStdDev) < epsilon && groupSize < minGroupSize) {
                                // If the SD is a perfect tie, choose the smaller size.
                                bestGroupIndex = i;
                                minOverallStdDev = currentStdDev;
                                minGroupSize = groupSize;
                            }
                        }

                        if (bestGroupIndex !== -1) {
                            groups[bestGroupIndex].push(student);
                            assignedStudentIds.add(student.id);
                        } else {
                            window.showMessage("error", `Could not place student ${student.name} into any group. This may be due to too many 'Must Be Separated' constraints relative to the number of groups.`);
                            success = false;
                            break;
                        }
                    }
                }

                generateButton.disabled = false;
                generateButton.innerHTML = originalHtml;

                if (success) {
                    lastGeneratedGroups = groups;
                    window.renderGroupResults(groups);
                    window.showMessage("success", `Successfully generated ${numGroups} globally balanced groups for the local roster.`);

                } else {
                    lastGeneratedGroups = [];
                    document.getElementById('results-card').style.display = '-';
                }
            }, 50);
        };


        window.renderGroupResults = (groups) => {
            const resultsContainer = document.getElementById('group-results');
            resultsContainer.innerHTML = '';
            document.getElementById('results-card').style.display = 'block';

            groups.forEach((group, index) => {
                // Now using the average scores for display
                const { avgBehavior, avgAcademic, leaderCount } = calculateGroupScore(group);

                const groupElement = document.createElement('div');
                groupElement.className = 'bg-teal-50 p-4 rounded-lg border border-teal-200';
                groupElement.innerHTML = `
                    <h3 class="text-lg font-semibold text-teal-800 mb-2">Group ${index + 1} <span class="text-sm font-normal text-teal-600">(${group.length} students)</span></h3>

                    <div class="flex flex-wrap gap-4 text-sm mb-3">
                        <div class="flex items-center text-gray-700">
                            <i class="fas fa-face-smile w-4 h-4 mr-1 text-green-500"></i>
                            Avg. Behavior Score: <span class="font-medium ml-1">${avgBehavior.toFixed(2)}</span>
                        </div>
                        <div class="flex items-center text-gray-700">
                            <i class="fas fa-book w-4 h-4 mr-1 text-yellow-500"></i>
                            Avg. Academic Score: <span class="font-medium ml-1">${avgAcademic.toFixed(2)}</span>
                        </div>
                        <div class="flex items-center text-gray-700">
                            <svg class="w-4 h-4 mr-1 text-purple-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>
                            Leaders: <span class="font-medium ml-1">${leaderCount}</span>
                        </div>
                    </div>

                    <ul class="list-disc pl-5 space-y-1 text-gray-800">
                        ${group.map(s => {
                            let roleText = '';
                            if (['Leader', 'Bully', 'Victim'].includes(s.role)) {
                                roleText = `<span class="text-xs ml-1 font-semibold text-gray-600">(${s.role})</span>`;
                            }

                            return `
                                <li class="text-sm">
                                    ${s.name} <span class="font-bold text-teal-700">(${s.behavior}/${s.academics})</span>${roleText}
                                </li>
                            `;
                        }).join('')}
                    </ul>
                `;
                resultsContainer.appendChild(groupElement);
            });
        };

        window.showMessage = (type, message) => {
            const box = document.getElementById('message-box');
            box.textContent = message;
            box.className = 'p-3 rounded-lg text-sm font-medium transition duration-300';

            if (type === 'error') {
                box.classList.add('bg-red-100', 'border-red-500', 'text-red-800', 'border');
            } else if (type === 'success') {
                box.classList.add('bg-green-100', 'border-green-500', 'text-green-800', 'border');
            } else if (type === 'warning') {
                box.classList.add('bg-yellow-100', 'border-yellow-500', 'text-yellow-800', 'border');
            }
            box.style.display = 'block';
        };

        window.exportToCSV = () => {
            if (lastGeneratedGroups.length === 0) {
                window.showMessage('warning', 'Please generate groups first before attempting to export.');
                return;
            }

            let csvContent = "Group,Name,Behavior Score,Academic Grade,Role\n";

            lastGeneratedGroups.forEach((group, groupIndex) => {
                const groupNumber = `Group ${groupIndex + 1}`;
                group.forEach(student => {
                    const name = student.name.replace(/"/g, '""');
                    csvContent += `"${groupNumber}","${name}",${student.behavior},${student.academics},"${student.role}"\n`;
                });
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `${currentRosterName.replace(/ /g, '_')}_groups.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.showMessage('success', 'Groups successfully exported to CSV.');
        };

        window.exportToPDF = async () => {
            if (lastGeneratedGroups.length === 0) {
                window.showMessage('warning', 'Please generate groups first before attempting to export.');
                return;
            }

            const resultsCard = document.getElementById('results-card');
            const exportActions = document.getElementById('export-actions-container');
            const pdfButton = document.getElementById('pdf-export-content');

            pdfButton.innerHTML = '<div class="spinner"></div><span class="ml-2">Generating PDF...</span>';
            if (exportActions) exportActions.style.pointerEvents = '-';

            try {
                const JsPDF = window.jspdf.jsPDF;

                const exportButtons = document.getElementById('export-actions-container');
                exportButtons.classList.add('hidden');

                const canvas = await html2canvas(resultsCard, {
                    scale: 2,
                    logging: false,
                    allowTaint: true,
                    useCORS: true,
                    backgroundColor: '#ffffff'
                });

                exportButtons.classList.remove('hidden');

                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 200;
                const pageHeight = 295;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                const pdf = new JsPDF('p', 'mm', 'a4');

                // Add a title to the PDF
                pdf.setFontSize(16);
                pdf.text(`Group Results for ${currentRosterName}`, 10, 15);
                
                // Starting position after the title
                position = 20;

                // Scale image data to fit the page width and calculate its height
                const contentWidth = 190; // Use 190mm width for margins
                const contentHeight = canvas.height * contentWidth / canvas.width;

                pdf.addImage(imgData, 'PNG', 10, position, contentWidth, contentHeight);
                heightLeft = contentHeight;

                let pageY = position + contentHeight;
                let currentPage = 1;

                while (heightLeft > pageHeight - position) {
                    position = -(pageY - pageHeight * currentPage);
                    pdf.addPage();
                    currentPage++;
                    pdf.addImage(imgData, 'PNG', 10, position, contentWidth, contentHeight);
                    heightLeft -= (pageHeight - (pageY - pageHeight * (currentPage - 1)));
                    pageY += (pageHeight - (pageY - pageHeight * (currentPage - 1)));
                }


                pdf.save(`${currentRosterName.replace(/ /g, '_')}_groups.pdf`);

                window.showMessage('success', 'Groups successfully exported to PDF.');
            } catch (error) {
                console.error("PDF generation failed:", error);
                window.showMessage('error', 'Failed to generate PDF. Check the console for details.');
            } finally {
                pdfButton.innerHTML = '<i class="fas fa-file-pdf mr-2"></i> Export to PDF';
                if (exportActions) exportActions.style.pointerEvents = 'auto';
            }
        };

        // --- Execution Start ---
        // Load data from local storage or use defaults
        loadStudents();
        // Fallback to default if no data is found after loading
        if (students.length === 0) {
             window.addDefaultStudents();
        }
        window.renderStudentRoster();
        window.renderConstraints();

    </script>


    <div class="max-w-7xl mx-auto space-y-8">
        <header class="text-center py-6 bg-teal-600 rounded-xl shadow-lg relative">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-white">üóÇÔ∏è Balanced Student Group Generator</h1>
            <p class="text-teal-200 mt-1">Efficiently create teams balanced by behavior, academics, and custom constraints.</p>
        </header>

        <div id="message-box" class="hidden p-3 rounded-lg text-sm font-medium transition duration-300"></div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 card">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-user-check mr-2 text-teal-600"></i>
                    Student Roster
                </h2>

                <div class="overflow-x-auto mb-4">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-slate-100">
                            <tr>
                                <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Name</th>
                                <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Behavior (1-5)</th>
                                <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Academics (A-E)</th>
                                <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Role</th>
                                <th class="p-3"></th>
                            </tr>
                        </thead>
                        <tbody id="student-list" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>

                <p id="empty-roster-message" class="text-center text-gray-500 py-8 hidden">
                    No students added yet. Click "Add Student" to begin building your roster.
                </p>

                <div class="flex flex-wrap justify-between items-center mt-4">
                    <button onclick="window.addStudentRow()" class="btn-secondary flex items-center">
                        <svg class="w-5 h-5 mr-1" fill="-" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        Add Student
                    </button>
                    <button onclick="window.addDefaultStudents()" class="btn-secondary flex items-center bg-blue-100 text-blue-600 border-blue-600 hover:bg-blue-200">
                        <i class="fas fa-database mr-1"></i> Load Sample Roster
                    </button>
                </div>
            </div>

            <div class="lg:col-span-1 space-y-6">

                <div class="card">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-handshake mr-2 text-teal-600"></i>
                        Must Be Together (Pairs)
                    </h2>
                    <p class="text-sm text-gray-600 mb-3">Select students who must be in the same group.</p>
                    <div id="must-be-together-list" class="space-y-3 mb-4">
                    </div>
                    <button onclick="window.addConstraint('together')" class="btn-secondary text-sm">
                        + Add Together Constraint
                    </button>
                </div>

                <div class="card">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-ban mr-2 text-teal-600"></i>
                        Must Be Separated (Groups)
                    </h2>
                    <p class="text-sm text-gray-600 mb-3">
                        Define groups of 2 or more students where **no two students** from the group can be placed in the same resulting team.
                        <span class="font-semibold text-red-500">(Bullies and Victims will also be separated automatically.)</span>
                    </p>
                    <div id="conflict-constraints-list" class="space-y-3 mb-4">
                    </div>
                    <button onclick="window.addConstraint('conflict')" class="btn-secondary text-sm bg-red-100 text-red-600 hover:bg-red-200">
                        + Add Separation Group
                    </button>
                </div>

                <div class="card">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-cogs mr-2 text-teal-600"></i>
                        Group Settings
                    </h2>
                    <label for="num-groups" class="block text-sm font-medium text-gray-700 mb-1">Number of Groups to Create</label>
                    <input type="number" id="num-groups" value="4" min="1" class="input-field mb-4" />

                    <label class="block text-2xl font-extrabold text-gray-700 mb-3">GENERATE GROUPS</label>

                    <button id="generate-button" onclick="window.generateGroups()" class="btn-primary w-full flex items-center justify-center">
                        <i class="fas fa-sitemap mr-3"></i>
                        GENERATE GROUPS NOW
                    </button>
                </div>

            </div>
        </div>

        <div id="results-card" class="card mt-8 hidden">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                <h2 class="text-3xl font-bold text-teal-700 flex items-center mb-4 sm:mb-0">
                    <i class="fas fa-users-gear mr-2"></i> Final Grouping Results
                </h2>
                <div id="export-actions-container" class="flex space-x-2 export-actions">
                    <button onclick="window.exportToCSV()" class="btn-export flex items-center">
                        <i class="fas fa-file-csv mr-2"></i> Export to CSV
                    </button>
                    <button onclick="window.exportToPDF()" class="btn-pdf flex items-center" id="pdf-export-content">
                        <i class="fas fa-file-pdf mr-2"></i> Export to PDF
                    </button>
                </div>
            </div>

            <div id="group-results" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
            </div>
        </div>
    </div>

</body>
</html>
