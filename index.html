<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Balanced Student Group Generator</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- jsPDF and html2canvas for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
            padding: 2rem;
        }
        .card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05), 0 1px 3px rgba(0, 0, 0, 0.02);
            border: 1px solid #e2e8f0;
        }
        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-field:focus {
            border-color: #0d9488;
            outline: none;
            box-shadow: 0 0 0 2px rgba(13, 148, 136, 0.2);
        }
        .btn-primary {
            background-color: #0d9488;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s;
        }
        .btn-primary:hover {
            background-color: #0f766e;
            transform: translateY(-1px);
        }
        .btn-secondary {
            background-color: #f0fdfa;
            color: #0d9488;
            padding: 0.5rem 1rem;
            border: 1px solid #0d9488;
            border-radius: 8px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #ccfbf1;
        }
        .btn-danger {
            background-color: #fee2e2;
            color: #dc2626;
            padding: 0.25rem 0.5rem;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .btn-danger:hover {
            background-color: #fecaca;
        }
        .btn-export {
            background-color: #e5e7eb;
            color: #4b5563;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .btn-export:hover {
            background-color: #d1d5db;
        }
        .btn-pdf {
            background-color: #fef2f2;
            color: #ef4444;
            padding: 0.5rem 1rem;
            border: 1px solid #ef4444;
            border-radius: 8px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .btn-pdf:hover {
            background-color: #fee2e2;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0d9488;
            border-radius: 50%;
            width: 1rem;
            height: 1rem;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Custom styling for the results display */
        .role-tag {
            display: inline-block;
            padding: 2px 8px;
            margin-left: 8px;
            border-radius: 9999px; /* Full rounded corners */
            font-size: 0.75rem; /* text-xs */
            font-weight: 600; /* font-semibold */
        }
        .tag-leader { background-color: #f3e8ff; color: #9333ea; } /* Purple */
        .tag-bully { background-color: #fee2e2; color: #dc2626; } /* Red */
        .tag-victim { background-color: #fffbeb; color: #d97706; } /* Amber/Orange */
        .tag-none { background-color: #f1f5f9; color: #64748b; } /* Slate */
    </style>
</head>
<body>

    <script>
        // --- GLOBAL STATE & CONFIGURATION (Piece 1/2) ---
        let students = [];
        let mustBeTogether = []; // Array of arrays: [['id1', 'id2'], ...]
        let conflictConstraints = []; // Array of arrays: [['id1', 'id2', 'id3'], ...]
        let currentRosterName = 'Sample Class Roster';
        let lastGeneratedGroups = [];
        
        // Constants for the balancing algorithm
        const epsilon = 1e-6; // Tolerance for floating point equality checks


        // --- UTILITY FUNCTIONS (Piece 1/2) ---

        /** Converts academic grade (A-E) to a numeric score (5-1, where 5=best). */
        const academicsToScore = (grade) => {
            switch (grade.toUpperCase()) {
                case 'A': return 5;
                case 'B': return 4;
                case 'C': return 3;
                case 'D': return 2;
                case 'E': return 1;
                default: return 3; // Default to C/Average
            }
        };
        
        /** * Converts behavior score (1-5, where 1=best/most self-control) 
         * to a normalized score (5-1, where 5=best) to align with academic scoring for balancing.
         */
        const behaviorToScore = (score) => {
            // Formula: 6 - score. If input is 1 (best), output is 5. If input is 5 (worst), output is 1.
            return 6 - score;
        };

        /** Calculates group statistics (size, combined average score, leader count). */
        const calculateGroupScore = (group) => {
            if (group.length === 0) {
                return { size: 0, avgBehaviorNormalized: 0, avgBehaviorRaw: 0, avgAcademic: 0, combinedAvg: 0, leaderCount: 0 };
            }

            // Use the normalized scores for balancing (5=best for both metrics)
            const totalBehaviorScoreNormalized = group.reduce((sum, s) => sum + behaviorToScore(s.behavior), 0);
            const totalAcademicScore = group.reduce((sum, s) => sum + academicsToScore(s.academics), 0);
            
            // Calculate the RAW average behavior score (1=Best, 5=Worst) for display purposes
            const totalBehaviorScoreRaw = group.reduce((sum, s) => sum + s.behavior, 0);

            const leaderCount = group.filter(s => s.role === 'Leader').length;
            const size = group.length;

            const avgBehaviorNormalized = totalBehaviorScoreNormalized / size;
            const avgAcademic = totalAcademicScore / size;
            const combinedAvg = (avgBehaviorNormalized + avgAcademic) / 2; // Average of the two normalized averages

            const avgBehaviorRaw = totalBehaviorScoreRaw / size;


            return { size, avgBehaviorNormalized, avgBehaviorRaw, avgAcademic, combinedAvg, leaderCount };
        };

        /** Calculates the Standard Deviation of an array of scores (combinedAvg from group stats). */
        const calculateStdDev = (groupStats) => {
            if (groupStats.length === 0) return 0;
            
            const scores = groupStats.map(s => s.combinedAvg);
            const sum = scores.reduce((acc, score) => acc + score, 0);
            const mean = sum / scores.length;
            const squaredDifferences = scores.map(score => Math.pow(score - mean, 2));
            // Use the population standard deviation formula (n in denominator)
            const variance = squaredDifferences.reduce((acc, diff) => acc + diff, 0) / scores.length;
            
            return Math.sqrt(variance);
        };

        /** Checks if a student conflicts with any member of a group based on constraints and roles. */
        const hasConflict = (student, group, conflictList) => {
            // 1. Check Bully/Victim/Bully-Victim separation (Constraint 2)
            const isBully = student.role === 'Bully';
            const isVictim = student.role === 'Victim';

            for (const member of group) {
                // Bully cannot be with Victim
                if ((isBully && member.role === 'Victim') || (isVictim && member.role === 'Bully')) {
                    return true;
                }
                // Bully cannot be with another Bully (to spread out disruptive students)
                if (isBully && member.role === 'Bully') {
                    return true;
                }
            }
            
            // 2. Check explicit "Must Be Separated" constraints (Constraint 3)
            const studentId = student.id;
            for (const separationGroup of conflictList) {
                // Check if the current student is part of the separation group
                if (separationGroup.includes(studentId)) {
                    // Check if any existing member of the target group is ALSO in the separation group
                    for (const member of group) {
                        if (separationGroup.includes(member.id)) {
                            // Conflict found: both student and member are in the same separation group
                            return true;
                        }
                    }
                }
            }

            return false;
        };

        /** Finds a student's name by their ID. */
        const getStudentNameById = (id) => {
            const student = students.find(s => s.id === id);
            return student ? student.name : `[Unknown Student: ${id}]`;
        };
        
        /** Calculates the equitable size targets for all groups (Constraint 1). */
        const calculateEquitableSizes = (totalStudents, numGroups) => {
            const baseSize = Math.floor(totalStudents / numGroups);
            const groupsWithExtra = totalStudents % numGroups;
            
            const targetSizes = Array(numGroups).fill(baseSize);
            // The first 'groupsWithExtra' groups get one extra student
            for (let i = 0; i < groupsWithExtra; i++) {
                targetSizes[i] += 1;
            }
            return targetSizes;
        };


        // --- DATA MANAGEMENT (Piece 1/2) ---

        /** Saves the current state to Local Storage. */
        window.saveStudents = () => {
            const data = {
                students: students,
                mustBeTogether: mustBeTogether,
                conflictConstraints: conflictConstraints,
                rosterName: currentRosterName
            };
            localStorage.setItem('studentGroupData', JSON.stringify(data));
        };

        /** Loads state from Local Storage. */
        const loadStudents = () => {
            const dataString = localStorage.getItem('studentGroupData');
            if (dataString) {
                try {
                    const data = JSON.parse(dataString);
                    // Filter out students with null/undefined IDs to maintain data integrity
                    students = (data.students || []).filter(s => s.id);
                    mustBeTogether = data.mustBeTogether || [];
                    conflictConstraints = data.conflictConstraints || [];
                    currentRosterName = data.rosterName || 'Class Roster';
                } catch (e) {
                    console.error("Error loading data from local storage:", e);
                    window.showMessage('error', 'Error loading saved data. Resetting roster.');
                    students = [];
                    mustBeTogether = [];
                    conflictConstraints = [];
                }
            }
        };

        /** Adds sample data to the roster. */
        window.addDefaultStudents = () => {
            // NOTE: Behavior is now 1=Best, 5=Worst
            students = [
                { id: crypto.randomUUID(), name: 'Alice Johnson', behavior: 1, academics: 'A', role: '-' }, // Best Behavior
                { id: crypto.randomUUID(), name: 'Bob Smith', behavior: 3, academics: 'C', role: '-' },
                { id: crypto.randomUUID(), name: 'Charlie Brown', behavior: 4, academics: 'D', role: 'Bully' }, // Bad Behavior
                { id: crypto.randomUUID(), name: 'Dana Scully', behavior: 1, academics: 'A', role: 'Leader' },
                { id: crypto.randomUUID(), name: 'Eli Vance', behavior: 2, academics: 'B', role: '-' },
                { id: crypto.randomUUID(), name: 'Fiona Glenanne', behavior: 5, academics: 'E', role: 'Victim' }, // Worst Behavior, Lowest Academics
                { id: crypto.randomUUID(), name: 'Gary Oldman', behavior: 3, academics: 'C', role: '-' },
                { id: crypto.randomUUID(), name: 'Hannah Montana', behavior: 1, academics: 'B', role: 'Leader' },
                { id: crypto.randomUUID(), name: 'Ivan Drago', behavior: 4, academics: 'D', role: '-' },
                { id: crypto.randomUUID(), name: 'Jenna Rink', behavior: 2, academics: 'A', role: '-' },
                { id: crypto.randomUUID(), name: 'Kyle Reese', behavior: 3, academics: 'C', role: '-' },
                { id: crypto.randomUUID(), name: 'Laura Palmer', behavior: 2, academics: 'A', role: '-' },
                { id: crypto.randomUUID(), name: 'Mike Ehrmantraut', behavior: 1, academics: 'B', role: '-' },
                { id: crypto.randomUUID(), name: 'Nancy Drew', behavior: 5, academics: 'C', role: 'Victim' },
            ];
            
            const nameToId = {};
            students.forEach(s => nameToId[s.name.split(' ')[0].toLowerCase()] = s.id);

            mustBeTogether = [
                [nameToId.alice, nameToId.bob].filter(id => id),
                [nameToId.jenna, nameToId.laura].filter(id => id)
            ].filter(pair => pair.length === 2);

            // Example conflict constraint (e.g., Ivan and Kyle must be separated)
            conflictConstraints = [
                [nameToId.kyle, nameToId.ivan].filter(id => id)
            ].filter(group => group.length >= 2);
            
            window.saveStudents();
            window.renderStudentRoster();
            window.renderConstraints();
            window.showMessage('success', 'Sample Roster Loaded. Roster and constraints have been reset.');
        };


        // --- ROSTER UI RENDERING & INTERACTION (Piece 1/2) ---

        /** Renders the main student roster table. */
        window.renderStudentRoster = () => {
            const list = document.getElementById('student-list');
            list.innerHTML = '';

            students.forEach((s, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition duration-150';
                
                // Name
                row.innerHTML += `
                    <td class="p-3 whitespace-nowrap">
                        <input type="text" value="${s.name}" onchange="window.updateStudent('${s.id}', 'name', this.value)" 
                                class="w-full text-gray-800 font-medium bg-transparent border-b border-gray-200 focus:border-teal-500 outline-none" placeholder="Student Name" />
                    </td>`;
                
                // Behavior Score (1-5) - Now 1=Best, 5=Worst
                row.innerHTML += `
                    <td class="p-3">
                        <select onchange="window.updateStudent('${s.id}', 'behavior', parseInt(this.value))" 
                                class="input-field p-1 text-center bg-white">
                            ${[1, 2, 3, 4, 5].map(score => // Displaying 1 to 5
                                `<option value="${score}" ${s.behavior === score ? 'selected' : ''}>${score}</option>`
                            ).join('')}
                        </select>
                    </td>`;
                
                // Academic Grade (A-E)
                row.innerHTML += `
                    <td class="p-3">
                        <select onchange="window.updateStudent('${s.id}', 'academics', this.value)" 
                                class="input-field p-1 text-center bg-white">
                            ${['A', 'B', 'C', 'D', 'E'].map(grade => 
                                `<option value="${grade}" ${s.academics === grade ? 'selected' : ''}>${grade}</option>`
                            ).join('')}
                        </select>
                    </td>`;
                
                // Role (Leader, Bully, Victim, -)
                row.innerHTML += `
                    <td class="p-3">
                        <select onchange="window.updateStudent('${s.id}', 'role', this.value)" 
                                class="input-field p-1 text-center bg-white ${s.role === 'Leader' ? 'text-purple-600' : s.role === 'Bully' ? 'text-red-600' : s.role === 'Victim' ? 'text-yellow-600' : 'text-gray-600'}">
                            ${['-', 'Leader', 'Bully', 'Victim'].map(role => 
                                `<option value="${role}" ${s.role === role ? 'selected' : ''}>${role}</option>`
                            ).join('')}
                        </select>
                    </td>`;

                // Delete Button
                row.innerHTML += `
                    <td class="p-3 text-right">
                        <button onclick="window.deleteStudent('${s.id}')" class="btn-danger">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>`;
                
                list.appendChild(row);
            });

            document.getElementById('empty-roster-message').classList.toggle('hidden', students.length > 0);
        };

        /** Adds a new, empty student row. */
        window.addStudentRow = () => {
            const newStudent = {
                id: crypto.randomUUID(),
                name: 'New Student',
                behavior: 3, // Default to average
                academics: 'C',
                role: '-'
            };
            students.push(newStudent);
            window.saveStudents();
            window.renderStudentRoster();
            window.showMessage('success', 'Student added. Remember to update their details.');
        };

        /** Deletes a student by ID. */
        window.deleteStudent = (id) => {
            // Remove from students array
            students = students.filter(s => s.id !== id);
            
            // Remove from constraints
            mustBeTogether = mustBeTogether.filter(pair => !pair.includes(id));
            conflictConstraints = conflictConstraints.filter(group => !group.includes(id));

            window.saveStudents();
            window.renderStudentRoster();
            window.renderConstraints();
            window.showMessage('success', 'Student and associated constraints removed.');
        };

        /** Updates a student field by ID. */
        window.updateStudent = (id, field, value) => {
            const studentIndex = students.findIndex(s => s.id === id);
            if (studentIndex > -1) {
                students[studentIndex][field] = value;
                window.saveStudents();
                window.renderStudentRoster(); // Re-render to update classes/UI
                window.renderConstraints(); // Re-render constraints to update names
            }
        };

        // --- CONSTRAINT MANAGEMENT (Piece 1/2) ---

        /** Adds a new empty constraint (either 'together' pair or 'conflict' group). */
        window.addConstraint = (type) => {
            if (students.length < 2) {
                window.showMessage('error', 'You need at least two students to set a constraint.');
                return;
            }

            if (type === 'together') {
                mustBeTogether.push([students[0].id, students[1].id]);
            } else if (type === 'conflict') {
                conflictConstraints.push([students[0].id, students[1].id]);
            }
            window.saveStudents();
            window.renderConstraints();
            window.showMessage('success', `New ${type} constraint added.`);
        };

        /** Renders all constraint lists. */
        window.renderConstraints = () => {
            const renderSelect = (currentId, constraintType, constraintIndex, elementIndex) => {
                const options = students.map(s => `
                    <option value="${s.id}" ${s.id === currentId ? 'selected' : ''}>
                        ${s.name}
                    </option>
                `).join('');

                return `
                    <select onchange="window.updateConstraint('${constraintType}', ${constraintIndex}, ${elementIndex}, this.value)" class="input-field p-1 text-sm bg-white">
                        ${options}
                    </select>
                `;
            };

            const togetherList = document.getElementById('must-be-together-list');
            togetherList.innerHTML = mustBeTogether.map((pair, index) => `
                <div class="flex items-center space-x-2 bg-white p-2 rounded-lg border border-teal-100">
                    ${renderSelect(pair[0], 'together', index, 0)}
                    <span class="text-teal-700 font-semibold">AND</span>
                    ${renderSelect(pair[1], 'together', index, 1)}
                    <button onclick="window.removeConstraint('together', ${index})" class="btn-danger flex-shrink-0">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');

            const conflictList = document.getElementById('conflict-constraints-list');
            conflictList.innerHTML = conflictConstraints.map((group, index) => {
                const studentSelectors = group.map((id, elementIndex) => 
                    renderSelect(id, 'conflict', index, elementIndex)
                ).join('');

                return `
                    <div class="space-y-2 bg-white p-3 rounded-lg border border-red-100">
                        <div class="flex flex-wrap gap-2 items-center">
                            <span class="text-sm font-semibold text-red-600">Group ${index + 1}:</span>
                            ${studentSelectors}
                            <button onclick="window.addStudentToConflictGroup(${index})" class="btn-secondary text-xs p-1 h-fit">
                                + Add
                            </button>
                        </div>
                        <button onclick="window.removeConstraint('conflict', ${index})" class="btn-danger w-full mt-1">
                            Remove Separation Group
                        </button>
                    </div>
                `;
            }).join('');
        };

        /** Updates a specific element within a constraint. */
        window.updateConstraint = (type, constraintIndex, elementIndex, studentId) => {
            if (type === 'together') {
                mustBeTogether[constraintIndex][elementIndex] = studentId;
            } else if (type === 'conflict') {
                conflictConstraints[constraintIndex][elementIndex] = studentId;
                // Ensure no duplicates in conflict group
                const group = conflictConstraints[constraintIndex];
                conflictConstraints[constraintIndex] = [...new Set(group)];
            }
            window.saveStudents();
            window.renderConstraints();
        };

        /** Adds a default student to an existing conflict constraint group. */
        window.addStudentToConflictGroup = (constraintIndex) => {
            if (students.length === 0) return;
            // Add the first student's ID who is NOT already in the group, or the first student if all are present
            const firstUnusedStudent = students.find(s => !conflictConstraints[constraintIndex].includes(s.id));
            const studentId = firstUnusedStudent ? firstUnusedStudent.id : students[0].id;

            conflictConstraints[constraintIndex].push(studentId);
            window.saveStudents();
            window.renderConstraints();
            window.showMessage('success', 'Student slot added to separation group.');
        };


        // --- CORE LOGIC & RENDERING (Piece 2/2) ---

        /** Removes a constraint by type and index. */
        window.removeConstraint = (type, index) => {
            if (type === 'together') {
                mustBeTogether.splice(index, 1);
            } else if (type === 'conflict') {
                conflictConstraints.splice(index, 1);
            }
            window.saveStudents();
            window.renderConstraints();
            window.showMessage('success', 'Constraint removed.');
        };


        /** Main group generation algorithm. */
        window.generateGroups = () => {
            const numGroups = parseInt(document.getElementById('num-groups').value, 10);
            const allStudents = students;
            const generateButton = document.getElementById('generate-button');
            const originalHtml = generateButton.innerHTML;
            
            window.showMessage('warning', 'Generating groups...');
            generateButton.disabled = true;
            generateButton.innerHTML = '<div class="spinner"></div><span class="ml-2">Generating...</span>';

            if (allStudents.length === 0) {
                window.showMessage('error', 'The roster is empty. Please add students first.');
                generateButton.disabled = false;
                generateButton.innerHTML = originalHtml;
                return;
            }

            if (numGroups <= 0) {
                window.showMessage('error', 'The number of groups must be 1 or more.');
                generateButton.disabled = false;
                generateButton.innerHTML = originalHtml;
                return;
            }

            if (numGroups > allStudents.length) {
                window.showMessage('error', `You cannot create ${numGroups} groups for only ${allStudents.length} students.`);
                generateButton.disabled = false;
                generateButton.innerHTML = originalHtml;
                return;
            }
            
            // Use a timeout to allow the spinner to render before the heavy calculation
            setTimeout(() => {
                // Filter and clean constraints
                const validStudents = new Set(allStudents.map(s => s.id));
                const isValidConstraintPair = (c) => c.length === 2 && validStudents.has(c[0]) && validStudents.has(c[1]);
                const isValidSeparationGroup = (c) => c.length >= 2 && c.every(id => validStudents.has(id));

                const validMustBeTogether = mustBeTogether.filter(isValidConstraintPair);
                const validConflictConstraints = conflictConstraints.filter(isValidSeparationGroup);

                let groups = Array.from({ length: numGroups }, () => []);
                let assignedStudentIds = new Set();
                let success = true;
                
                // --- SETUP FOR PRIORITY 1: Equitable Group Sizes ---
                const totalUnassigned = allStudents.length;
                const targetSizes = calculateEquitableSizes(totalUnassigned, numGroups);
                

                // --- 1. Handle Must Be Together Constraints (Constraint 4 - Highest Code Priority) ---
                for (const constraint of validMustBeTogether) {
                    const [id1, id2] = constraint;
                    const s1 = allStudents.find(s => s.id === id1);
                    const s2 = allStudents.find(s => s.id === id2);

                    if (assignedStudentIds.has(id1) || assignedStudentIds.has(id2) || !s1 || !s2) {
                        continue;
                    }

                    // Pre-check: Constraint 2/3 must be satisfied internally
                    if (hasConflict(s1, [s2], validConflictConstraints)) {
                        window.showMessage("error", `Cannot satisfy 'Must Be Together' constraint: ${s1.name} and ${s2.name} have an automatic (Bully/Victim) or explicit conflict.`);
                        success = false;
                        break;
                    }

                    let bestGroupIndex = -1;
                    let minSize = Infinity; 

                    // Find the smallest group that has capacity (for initial size balancing) and no conflicts
                    for (let i = 0; i < numGroups; i++) {
                        // Check Constraint 2 and 3 (Bully/Victim and Separation)
                        const conflicts1 = hasConflict(s1, groups[i], validConflictConstraints);
                        const conflicts2 = hasConflict(s2, groups[i], validConflictConstraints);

                        // Size check: Ensure room for the pair, assuming the initial total student count calculation.
                        // We use a simple min size approach here and rely on the main loop for strict size control.
                        if (groups[i].length < minSize && !conflicts1 && !conflicts2) {
                            minSize = groups[i].length;
                            bestGroupIndex = i;
                        }
                    }

                    if (bestGroupIndex !== -1) {
                        groups[bestGroupIndex].push(s1, s2);
                        assignedStudentIds.add(id1);
                        assignedStudentIds.add(id2);
                    } else {
                        window.showMessage("error", `Cannot satisfy a 'Must Be Together' constraint for ${s1.name} and ${s2.name} due to conflicts with existing group members.`);
                        success = false;
                        break;
                    }
                }
                
                // --- 2. Assign Remaining Students (Constraints 1, 2, 3, 5, 6, 7, 8) ---
                if (success) {
                    let unassignedStudents = allStudents.filter(s => !assignedStudentIds.has(s.id));

                    // Sort: Prioritize high-impact students for better SD distribution (Constraints 7/8).
                    unassignedStudents.sort((a, b) => {
                        const roleOrder = (role) => {
                            if (role === 'Leader') return 3;
                            if (role === 'Bully' || role === 'Victim') return 2;
                            return 1;
                        };
                        const roleDiff = roleOrder(b.role) - roleOrder(a.role);
                        if (roleDiff !== 0) return roleDiff;

                        // Combined score tie-breaker (using the normalized 1-5 score, 5=best)
                        const scoreA = behaviorToScore(a.behavior) + academicsToScore(a.academics);
                        const scoreB = behaviorToScore(b.behavior) + academicsToScore(b.academics);
                        const scoreDiff = scoreB - scoreA;
                        if (scoreDiff !== 0) return scoreDiff;

                        // Final random tie-breaker
                        return Math.random() - 0.5;
                    });

                    for (const student of unassignedStudents) {
                        let bestGroupIndex = -1;
                        let minOverallStdDev = Infinity;
                        
                        for (let i = 0; i < numGroups; i++) {
                            const currentGroup = groups[i];

                            // --- PRIORITY 1: HARD SIZE LIMIT ---
                            if (groups[i].length >= targetSizes[i]) {
                                // This group is full based on the equitable size calculation. Skip it.
                                continue; 
                            }

                            // --- PRIORITY 2 & 3: HARD CONFLICT LIMITS ---
                            if (hasConflict(student, currentGroup, validConflictConstraints)) {
                                continue;
                            }

                            // --- PRIORITY 5, 6, 7, 8: SCORE BALANCING (SD Minimization) ---
                            const hypotheticalGroups = groups.map((g, index) =>
                                index === i ? [...g, student] : g
                            );

                            const hypotheticalGroupStats = hypotheticalGroups.map(g => calculateGroupScore(g));

                            // Calculate SD based on the *average combined score* of the hypothetical groups
                            const currentStdDev = calculateStdDev(hypotheticalGroupStats);

                            // Find the group that minimizes the SD (implements Constraints 5, 6, 7, 8)
                            if (currentStdDev < minOverallStdDev - epsilon) {
                                bestGroupIndex = i;
                                minOverallStdDev = currentStdDev;
                            }
                            
                            // If SD is a perfect tie, choose the group with the most remaining capacity 
                            // to maintain size flexibility for later students.
                            else if (Math.abs(currentStdDev - minOverallStdDev) < epsilon && groups[i].length < groups[bestGroupIndex]?.length) {
                                bestGroupIndex = i;
                                minOverallStdDev = currentStdDev;
                            }
                        }

                        if (bestGroupIndex !== -1) {
                            groups[bestGroupIndex].push(student);
                            assignedStudentIds.add(student.id);
                        } else {
                            window.showMessage("error", `Could not place student ${student.name} into any group. This usually means a combination of hard constraints (Must Be Separated) prevents placement.`);
                            success = false;
                            break;
                        }
                    }
                }

                generateButton.disabled = false;
                generateButton.innerHTML = originalHtml;

                if (success) {
                    lastGeneratedGroups = groups;
                    window.renderGroupResults(groups);
                    window.showMessage("success", `Successfully generated ${numGroups} groups with strict size equity and balanced scores.`);

                } else {
                    lastGeneratedGroups = [];
                    document.getElementById('results-card').style.display = '-';
                }
            }, 50);
        };

        /** Renders the final groups into the results section. */
        window.renderGroupResults = (groups) => {
            const resultsContainer = document.getElementById('group-results');
            resultsContainer.innerHTML = '';
            document.getElementById('results-card').style.display = 'block';

            groups.forEach((group, index) => {
                // Destructure the new calculation results
                const { avgBehaviorNormalized, avgBehaviorRaw, avgAcademic, leaderCount } = calculateGroupScore(group);

                // Determine icon color based on the RAW average score (1=Best). User requested green emphasis.
                const behaviorIconColor = avgBehaviorRaw <= 2.5 ? 'text-green-500' : avgBehaviorRaw <= 4 ? 'text-yellow-500' : 'text-red-500';

                const groupElement = document.createElement('div');
                groupElement.className = 'bg-teal-50 p-4 rounded-lg border border-teal-200';
                groupElement.innerHTML = `
                    <h3 class="text-lg font-semibold text-teal-800 mb-2">Group ${index + 1} <span class="text-sm font-normal text-teal-600">(${group.length} students)</span></h3>

                    <div class="flex flex-wrap gap-4 text-sm mb-3">
                        <div class="flex items-center text-gray-700">
                            <i class="fas fa-face-smile w-4 h-4 mr-1 ${behaviorIconColor}"></i>
                            Avg. Behavior Score (Raw 1=Best): <span class="font-medium ml-1">${avgBehaviorRaw.toFixed(2)}</span>
                        </div>
                        <div class="flex items-center text-gray-700">
                            <i class="fas fa-book w-4 h-4 mr-1 text-yellow-500"></i>
                            Avg. Academic Score: <span class="font-medium ml-1">${avgAcademic.toFixed(2)}</span>
                        </div>
                        <div class="flex items-center text-gray-700">
                            <svg class="w-4 h-4 mr-1 text-purple-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>
                            Leaders: <span class="font-medium ml-1">${leaderCount}</span>
                        </div>
                    </div>

                    <ul class="list-disc pl-5 space-y-1 text-gray-800">
                        ${group.map(s => {
                            let roleTag = '';
                            if (s.role === 'Leader') {
                                roleTag = `<span class="role-tag tag-leader">Leader</span>`;
                            } else if (s.role === 'Bully') {
                                roleTag = `<span class="role-tag tag-bully">Bully</span>`; // Red as requested
                            } else if (s.role === 'Victim') {
                                roleTag = `<span class="role-tag tag-victim">Victim</span>`; // Orange as requested
                            }

                            // Cleaned up score label: (XY) as requested
                            const scoreLabel = `(${s.behavior}${s.academics})`;

                            return `
                                <li class="text-sm">
                                    ${s.name} 
                                    <span class="font-bold text-teal-700">
                                        ${scoreLabel}
                                    </span>
                                    ${roleTag}
                                </li>
                            `;
                        }).join('')}
                    </ul>
                `;
                resultsContainer.appendChild(groupElement);
            });
        };

        /** Displays a message in the message box. */
        window.showMessage = (type, message) => {
            const box = document.getElementById('message-box');
            box.textContent = message;
            box.className = 'p-3 rounded-lg text-sm font-medium transition duration-300';

            if (type === 'error') {
                box.classList.add('bg-red-100', 'border-red-500', 'text-red-800', 'border');
            } else if (type === 'success') {
                box.classList.add('bg-green-100', 'border-green-500', 'text-green-800', 'border');
            } else if (type === 'warning') {
                box.classList.add('bg-yellow-100', 'border-yellow-500', 'text-yellow-800', 'border');
            }
            box.style.display = 'block';
        };

        /** Exports the final groups to a CSV file. */
        window.exportToCSV = () => {
            if (lastGeneratedGroups.length === 0) {
                window.showMessage('warning', 'Please generate groups first before attempting to export.');
                return;
            }

            let csvContent = "Group,Name,Behavior Score (1=Best/5=Worst),Academic Grade (A=Best/E=Worst),Role\n";

            lastGeneratedGroups.forEach((group, groupIndex) => {
                const groupNumber = `Group ${groupIndex + 1}`;
                group.forEach(student => {
                    // Escape quotes in name
                    const name = student.name.replace(/"/g, '""'); 
                    csvContent += `"${groupNumber}","${name}",${student.behavior},${student.academics},"${student.role}"\n`;
                });
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `${currentRosterName.replace(/ /g, '_')}_groups.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.showMessage('success', 'Groups successfully exported to CSV.');
        };

        /** Exports the final results section to a PDF document. */
        window.exportToPDF = async () => {
            if (lastGeneratedGroups.length === 0) {
                window.showMessage('warning', 'Please generate groups first before attempting to export.');
                return;
            }

            const resultsCard = document.getElementById('results-card');
            const exportActions = document.getElementById('export-actions-container');
            const pdfButton = document.getElementById('pdf-export-content');
            
            // Show loading state
            const originalHtml = pdfButton.innerHTML;
            pdfButton.innerHTML = '<div class="spinner"></div><span class="ml-2">Generating PDF...</span>';
            if (exportActions) exportActions.style.pointerEvents = '-';

            try {
                // Ensure jsPDF library is available
                if (typeof window.jspdf === 'undefined' || typeof window.html2canvas === 'undefined') {
                    window.showMessage('error', 'PDF dependencies not loaded. Check internet connection.');
                    return;
                }
                const JsPDF = window.jspdf.jsPDF;

                // Temporarily hide the export buttons themselves before taking screenshot
                const exportButtons = document.getElementById('export-actions-container');
                exportButtons.classList.add('hidden');

                const canvas = await html2canvas(resultsCard, {
                    scale: 2,
                    logging: false,
                    allowTaint: true,
                    useCORS: true,
                    backgroundColor: '#ffffff'
                });

                // Show buttons again
                exportButtons.classList.remove('hidden');

                const imgData = canvas.toDataURL('image/png');
                const pdf = new JsPDF('p', 'mm', 'a4');
                const contentWidth = 190; // Page width - margins
                const contentHeight = canvas.height * contentWidth / canvas.width;
                let position = 20; // Starting position below title

                // Add a title to the PDF
                pdf.setFontSize(16);
                pdf.text(`Group Results for ${currentRosterName}`, 10, 15);
                
                // Add the image, managing pages
                let heightLeft = contentHeight;
                let pageY = position;
                let currentPage = 1;

                // First page image draw
                pdf.addImage(imgData, 'PNG', 10, pageY, contentWidth, contentHeight);
                heightLeft -= (295 - pageY); // Reduce the height left by the space consumed on the first page

                while (heightLeft > 0) {
                    position = 0; // Start new page at the top (0)
                    pdf.addPage();
                    currentPage++;
                    const sourceY = contentHeight - heightLeft;
                    const clippedHeight = Math.min(heightLeft, 295);

                    pdf.addImage(imgData, 'PNG', 10, position, contentWidth, contentHeight, null, 'NONE', 0, sourceY / 2, clippedHeight / 2);
                    heightLeft -= 295;
                }


                pdf.save(`${currentRosterName.replace(/ /g, '_')}_groups.pdf`);

                window.showMessage('success', 'Groups successfully exported to PDF.');
            } catch (error) {
                console.error("PDF generation failed:", error);
                window.showMessage('error', 'Failed to generate PDF. Check the console for details.');
            } finally {
                // Restore original state
                pdfButton.innerHTML = originalHtml;
                if (exportActions) exportActions.style.pointerEvents = 'auto';
            }
        };

        // --- Execution Start ---
        // Load data from local storage or use defaults
        loadStudents();
        // Fallback to default if no data is found after loading
        if (students.length === 0) {
             window.addDefaultStudents();
        }
        window.renderStudentRoster();
        window.renderConstraints();

    </script>


    <div class="max-w-7xl mx-auto space-y-8">
        <header class="text-center py-6 bg-teal-600 rounded-xl shadow-lg relative">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-white">üóÇÔ∏è Balanced Student Group Generator</h1>
            <p class="text-teal-200 mt-1">Efficiently create teams balanced by behavior, academics, and custom constraints.</p>
        </header>

        <!-- Message Box -->
        <div id="message-box" class="hidden p-3 rounded-lg text-sm font-medium transition duration-300"></div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Roster Section -->
            <div class="lg:col-span-2 card">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-user-check mr-2 text-teal-600"></i>
                    Student Roster
                </h2>

                <div class="overflow-x-auto mb-4">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-slate-100">
                            <tr>
                                <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Name</th>
                                <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Behavior (1=Best / 5=Worst)</th>
                                <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Academics (A=Best / E=Worst)</th>
                                <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Role</th>
                                <th class="p-3"></th>
                            </tr>
                        </thead>
                        <tbody id="student-list" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>

                <p id="empty-roster-message" class="text-center text-gray-500 py-8 hidden">
                    No students added yet. Click "Add Student" to begin building your roster.
                </p>

                <div class="flex flex-wrap justify-between items-center mt-4">
                    <button onclick="window.addStudentRow()" class="btn-secondary flex items-center">
                        <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        Add Student
                    </button>
                    <button onclick="window.addDefaultStudents()" class="btn-secondary flex items-center bg-blue-100 text-blue-600 border-blue-600 hover:bg-blue-200">
                        <i class="fas fa-database mr-1"></i> Load Sample Roster
                    </button>
                </div>
            </div>

            <!-- Constraints and Settings Column -->
            <div class="lg:col-span-1 space-y-6">

                <!-- Must Be Together Constraints -->
                <div class="card">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-handshake mr-2 text-teal-600"></i>
                        Must Be Together (Pairs)
                    </h2>
                    <p class="text-sm text-gray-600 mb-3">Select students who must be in the same group.</p>
                    <div id="must-be-together-list" class="space-y-3 mb-4">
                    </div>
                    <button onclick="window.addConstraint('together')" class="btn-secondary text-sm">
                        + Add Together Constraint
                    </button>
                </div>

                <!-- Must Be Separated Constraints -->
                <div class="card">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-ban mr-2 text-teal-600"></i>
                        Must Be Separated (Groups)
                    </h2>
                    <p class="text-sm text-gray-600 mb-3">
                        Define groups of 2 or more students where **no two students** from the group can be placed in the same resulting team.
                        <span class="font-semibold text-red-500">(Bullies and Victims will also be separated automatically.)</span>
                    </p>
                    <div id="conflict-constraints-list" class="space-y-3 mb-4">
                    </div>
                    <button onclick="window.addConstraint('conflict')" class="btn-secondary text-sm bg-red-100 text-red-600 hover:bg-red-200">
                        + Add Separation Group
                    </button>
                </div>

                <!-- Group Settings and Generate -->
                <div class="card">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-cogs mr-2 text-teal-600"></i>
                        Group Settings
                    </h2>
                    <label for="num-groups" class="block text-sm font-medium text-gray-700 mb-1">Number of Groups to Create</label>
                    <input type="number" id="num-groups" value="4" min="1" class="input-field mb-4" />

                    <label class="block text-2xl font-extrabold text-gray-700 mb-3">GENERATE GROUPS</label>

                    <button id="generate-button" onclick="window.generateGroups()" class="btn-primary w-full flex items-center justify-center">
                        <i class="fas fa-sitemap mr-3"></i>
                        GENERATE GROUPS NOW
                    </button>
                </div>

            </div>
        </div>

        <!-- Results Section -->
        <div id="results-card" class="card mt-8 hidden">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                <h2 class="text-3xl font-bold text-teal-700 flex items-center mb-4 sm:mb-0">
                    <i class="fas fa-users-gear mr-2"></i> Final Grouping Results
                </h2>
                <div id="export-actions-container" class="flex space-x-2 export-actions">
                    <button onclick="window.exportToCSV()" class="btn-export flex items-center">
                        <i class="fas fa-file-csv mr-2"></i> Export to CSV
                    </button>
                    <button onclick="window.exportToPDF()" class="btn-pdf flex items-center" id="pdf-export-content">
                        <i class="fas fa-file-pdf mr-2"></i> Export to PDF
                    </button>
                </div>
            </div>

            <div id="group-results" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
            </div>
        </div>
    </div>

</body>
</html>
